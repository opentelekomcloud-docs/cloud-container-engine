:original_name: cce_10_0549.html

.. _cce_10_0549:

Pre-upgrade Check
=================

The system performs a comprehensive pre-upgrade check before the cluster upgrade. If the cluster does not meet the pre-upgrade check conditions, the upgrade cannot continue. To prevent upgrade risks, you can perform pre-upgrade check according to the check items provided by this section.

.. table:: **Table 1** Check items

   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | No.                   | Check Item                                                          | Description                                                                                                                                                                                                                                             |
   +=======================+=====================================================================+=========================================================================================================================================================================================================================================================+
   | 1                     | :ref:`Node Restrictions <cce_10_0431>`                              | -  Check whether the node is available.                                                                                                                                                                                                                 |
   |                       |                                                                     | -  Check whether the node OS supports the upgrade.                                                                                                                                                                                                      |
   |                       |                                                                     | -  Check whether there are unexpected node pool tags in the node.                                                                                                                                                                                       |
   |                       |                                                                     | -  Check whether the Kubernetes node name is consistent with the ECS name.                                                                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 2                     | :ref:`Upgrade Management <cce_10_0432>`                             | Check whether the current user is in the upgrade blocklist.                                                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 3                     | :ref:`Add-ons <cce_10_0433>`                                        | -  Check whether the add-on status is normal.                                                                                                                                                                                                           |
   |                       |                                                                     | -  Check whether the add-on support the target version.                                                                                                                                                                                                 |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 4                     | :ref:`Helm Charts <cce_10_0434>`                                    | Check whether the current HelmRelease record contains discarded Kubernetes APIs that are not supported by the target cluster version. If yes, the Helm chart may be unavailable after the upgrade.                                                      |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 5                     | :ref:`SSH Connectivity of Master Nodes <cce_10_0435>`               | Check whether CCE can connect to your master nodes.                                                                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 6                     | :ref:`Node Pools <cce_10_0436>`                                     | Check the node pool status.                                                                                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 7                     | :ref:`Security Groups <cce_10_0437>`                                | Check whether the security group allows the master node to access nodes using ICMP.                                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 8                     | :ref:`To-Be-Migrated Nodes <cce_10_0439>`                           | Check whether the node needs to be migrated.                                                                                                                                                                                                            |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 9                     | :ref:`Discarded Kubernetes Resources <cce_10_0440>`                 | Check whether there are discarded resources in the clusters.                                                                                                                                                                                            |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 10                    | :ref:`Compatibility Risks <cce_10_0441>`                            | Read the version compatibility differences and ensure that they are not affected. The patch upgrade does not involve version compatibility differences.                                                                                                 |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 11                    | :ref:`Node CCE Agent Versions <cce_10_0442>`                        | Check whether cce-agent on the current node is of the latest version.                                                                                                                                                                                   |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 12                    | :ref:`Node CPU Usage <cce_10_0443>`                                 | Check whether the CPU usage of the node exceeds 90%.                                                                                                                                                                                                    |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 13                    | :ref:`CRDs <cce_10_0444>`                                           | -  Check whether the key CRD **packageversions.version.cce.io** of the cluster is deleted.                                                                                                                                                              |
   |                       |                                                                     | -  Check whether the cluster key CRD **network-attachment-definitions.k8s.cni.cncf.io** is deleted.                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 14                    | :ref:`Node Disks <cce_10_0445>`                                     | -  Check whether the key data disks on the node meet the upgrade requirements.                                                                                                                                                                          |
   |                       |                                                                     | -  Check whether the **/tmp** directory has 500 MiB available space.                                                                                                                                                                                    |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 15                    | :ref:`Node DNS <cce_10_0446>`                                       | -  Check whether the DNS configuration of the current node can resolve the OBS address.                                                                                                                                                                 |
   |                       |                                                                     | -  Check whether the current node can access the OBS address of the storage upgrade component package.                                                                                                                                                  |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 16                    | :ref:`Node Key Directory File Permissions <cce_10_0447>`            | Check whether the key directory **/var/paas** on the nodes contain files with abnormal owners or owner groups.                                                                                                                                          |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 17                    | :ref:`Kubelet <cce_10_0448>`                                        | Check whether the kubelet on the node is running properly.                                                                                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 18                    | :ref:`Node Memory <cce_10_0449>`                                    | Check whether the memory usage of the node exceeds 90%.                                                                                                                                                                                                 |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 19                    | :ref:`Node Clock Synchronization Server <cce_10_0450>`              | Check whether the clock synchronization server ntpd or chronyd of the node is running properly.                                                                                                                                                         |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 20                    | :ref:`Node OS <cce_10_0451>`                                        | Check whether the OS kernel version of the node is supported by CCE.                                                                                                                                                                                    |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 21                    | :ref:`Node CPUs <cce_10_0452>`                                      | Check whether the number of CPUs on the master node is greater than 2.                                                                                                                                                                                  |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 22                    | :ref:`Node Python Commands <cce_10_0453>`                           | Check whether the Python commands are available on a node.                                                                                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 23                    | :ref:`Node Readiness <cce_10_0455>`                                 | Check whether the nodes in the cluster are ready.                                                                                                                                                                                                       |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 24                    | :ref:`Node journald <cce_10_0456>`                                  | Check whether journald of a node is normal.                                                                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 25                    | :ref:`containerd.sock <cce_10_0457>`                                | Check whether the containerd.sock file exists on the node. This file affects the startup of container runtime in the Euler OS.                                                                                                                          |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 26                    | :ref:`Internal Errors <cce_10_0458>`                                | Before the upgrade, check whether an internal error occurs.                                                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 27                    | :ref:`Node Mount Points <cce_10_0459>`                              | Check whether inaccessible mount points exist on the node.                                                                                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 28                    | :ref:`Kubernetes Node Taints <cce_10_0460>`                         | Check whether the taint needed for cluster upgrade exists on the node.                                                                                                                                                                                  |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 29                    | :ref:`everest Restrictions <cce_10_0478>`                           | Check whether there are any compatibility restrictions on the current everest add-on.                                                                                                                                                                   |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 30                    | :ref:`cce-hpa-controller Restrictions <cce_10_0479>`                | Check whether the current cce-controller-hpa add-on has compatibility restrictions.                                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 31                    | :ref:`Enhanced CPU Policies <cce_10_0480>`                          | Check whether the current cluster version and the target version support enhanced CPU policy.                                                                                                                                                           |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 32                    | :ref:`Health of Worker Node Components <cce_10_0484>`               | Check whether the container runtime and network components on the worker nodes are healthy.                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 33                    | :ref:`Health of Master Node Components <cce_10_0485>`               | Check whether the Kubernetes, container runtime, and network components of the master nodes are healthy.                                                                                                                                                |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 34                    | :ref:`Memory Resource Limit of Kubernetes Components <cce_10_0486>` | Check whether the resources of Kubernetes components, such as etcd and kube-controller-manager, exceed the upper limit.                                                                                                                                 |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 35                    | :ref:`Discarded Kubernetes APIs <cce_10_0487>`                      | The system scans the audit logs of the past day to check whether the user calls the deprecated APIs of the target Kubernetes version.                                                                                                                   |
   |                       |                                                                     |                                                                                                                                                                                                                                                         |
   |                       |                                                                     | .. note::                                                                                                                                                                                                                                               |
   |                       |                                                                     |                                                                                                                                                                                                                                                         |
   |                       |                                                                     |    Due to the limited time range of audit logs, this check item is only an auxiliary method. APIs to be deprecated may have been used in the cluster, but their usage is not included in the audit logs of the past day. Check the API usage carefully. |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 36                    | :ref:`IPv6 Capabilities of a CCE Turbo Cluster <cce_10_0488>`       | If IPv6 is enabled for a CCE Turbo cluster, check whether the target cluster version supports IPv6.                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 37                    | :ref:`Node NetworkManager <cce_10_0489>`                            | Check whether NetworkManager of a node is normal.                                                                                                                                                                                                       |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 38                    | :ref:`Node ID File <cce_10_0490>`                                   | Check the ID file format.                                                                                                                                                                                                                               |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 39                    | :ref:`Node Configuration Consistency <cce_10_0491>`                 | When you upgrade a CCE cluster to v1.19 or later, the system checks whether the following configuration files have been modified in the background.                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 40                    | :ref:`Node Configuration File <cce_10_0492>`                        | Check whether the configuration files of key components exist on the node.                                                                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 41                    | :ref:`CoreDNS Configuration Consistency <cce_10_0493>`              | Check whether the current CoreDNS key configuration Corefile is different from the Helm release record. The difference may be overwritten during the add-on upgrade, **affecting domain name resolution in the cluster**.                               |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 42                    | :ref:`sudo Commands of a Node <cce_10_0494>`                        | Check whether the sudo commands and sudo-related files of the node are working.                                                                                                                                                                         |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 43                    | :ref:`Key Commands of Nodes <cce_10_0495>`                          | Check whether some key commands that the node upgrade depends on are working.                                                                                                                                                                           |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 44                    | :ref:`Mounting of a Sock File on a Node <cce_10_0496>`              | The **docker/containerd.sock** file on the node is mounted to the pod through a hostPath. During the upgrade, Docker/containerd restarts, but the sock file in the container does not change. As a result, an error may occur in your services.         |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 45                    | :ref:`HTTPS Load Balancer Certificate Consistency <cce_10_0497>`    | Check whether the certificate used by an HTTPS load balancer has been modified on ELB.                                                                                                                                                                  |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 46                    | :ref:`Node Mounting <cce_10_0498>`                                  | Check whether the default mount directory and soft link on the node have been manually mounted or modified.                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 47                    | :ref:`Login Permissions of User paas on a Node <cce_10_0499>`       | Check whether user **paas** is allowed to log in to a node.                                                                                                                                                                                             |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 48                    | :ref:`Private IPv4 Addresses of Load Balancers <cce_10_0500>`       | Check whether the load balancer associated with a Service is allocated with a private IPv4 address.                                                                                                                                                     |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 49                    | :ref:`Historical Upgrade Records <cce_10_0501>`                     | Check whether the source version of the cluster is earlier than v1.11 and the target version is later than v1.23.                                                                                                                                       |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 50                    | :ref:`CIDR Block of the Cluster Management Plane <cce_10_0502>`     | Check whether the CIDR block of the cluster management plane is the same as that configured on the backbone network.                                                                                                                                    |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 51                    | :ref:`GPU Add-on <cce_10_0503>`                                     | The GPU add-on is involved in the upgrade, which may affect the GPU driver installation during the creation of a GPU node.                                                                                                                              |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 52                    | :ref:`Nodes' System Parameter Settings <cce_10_0504>`               | Check whether the default system parameter settings on your nodes are modified.                                                                                                                                                                         |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 53                    | :ref:`Residual Package Versions <cce_10_0505>`                      | Check whether there are residual package versions in the current cluster.                                                                                                                                                                               |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 54                    | :ref:`Node Commands <cce_10_0506>`                                  | Check whether the commands required for the upgrade are available on the node.                                                                                                                                                                          |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 55                    | :ref:`Node Swap <cce_10_0507>`                                      | Check whether swap has been enabled on cluster nodes.                                                                                                                                                                                                   |
   +-----------------------+---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
