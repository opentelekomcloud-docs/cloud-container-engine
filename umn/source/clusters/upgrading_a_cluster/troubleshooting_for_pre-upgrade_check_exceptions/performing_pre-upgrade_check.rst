:original_name: cce_10_0549.html

.. _cce_10_0549:

Performing Pre-upgrade Check
============================

The system performs a comprehensive pre-upgrade check before the cluster upgrade. If the cluster does not meet the pre-upgrade check conditions, the upgrade cannot continue. To prevent upgrade risks, you can perform pre-upgrade check according to the check items provided by this section.

.. table:: **Table 1** Check items

   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Check Item                                                          | Description                                                                                                                                                                                                               |
   +=====================================================================+===========================================================================================================================================================================================================================+
   | :ref:`Checking the Node <cce_10_0431>`                              | -  Check whether the node is available.                                                                                                                                                                                   |
   |                                                                     | -  Check whether the node OS supports the upgrade.                                                                                                                                                                        |
   |                                                                     | -  Check whether there are unexpected node pool tags in the node.                                                                                                                                                         |
   |                                                                     | -  Check whether the Kubernetes node name is consistent with the ECS name.                                                                                                                                                |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Blocklist <cce_10_0432>`                         | Check whether the current user is in the upgrade blocklist.                                                                                                                                                               |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Add-on <cce_10_0433>`                            | -  Check whether the add-on status is normal.                                                                                                                                                                             |
   |                                                                     | -  Check whether the add-on support the target version.                                                                                                                                                                   |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Helm Chart <cce_10_0434>`                        | Check whether the current HelmRelease record contains discarded Kubernetes APIs that are not supported by the target cluster version. If yes, the Helm chart may be unavailable after the upgrade.                        |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Master Node SSH Connectivity <cce_10_0435>`      | Check whether CCE can connect to your master nodes.                                                                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Node Pool <cce_10_0436>`                         | -  Check the node status.                                                                                                                                                                                                 |
   |                                                                     | -  Check whether the auto scaling function of the node pool is disabled.                                                                                                                                                  |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking the Security Group <cce_10_0437>`                    | Check whether the security group allows the master node to access nodes using ICMP.                                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`To-Be-Migrated Node <cce_10_0439>`                            | Check whether the node needs to be migrated.                                                                                                                                                                              |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Discarded Kubernetes Resource <cce_10_0440>`                  | Check whether there are discarded resources in the clusters.                                                                                                                                                              |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Compatibility Risk <cce_10_0441>`                             | Read the version compatibility differences and ensure that they are not affected.                                                                                                                                         |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node CCEAgent Version <cce_10_0442>`                          | Check whether cce-agent on the current node is of the latest version.                                                                                                                                                     |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node CPU Usage <cce_10_0443>`                                 | Check whether the CPU usage of the node exceeds 90%.                                                                                                                                                                      |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`CRD Check <cce_10_0444>`                                      | -  Check whether the key CRD **packageversions.version.cce.io** of the cluster is deleted.                                                                                                                                |
   |                                                                     | -  Check whether the cluster key CRD **network-attachment-definitions.k8s.cni.cncf.io** is deleted.                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Disk <cce_10_0445>`                                      | -  Check whether the key data disks on the node meet the upgrade requirements.                                                                                                                                            |
   |                                                                     | -  Check whether the **/tmp** directory has 500 MB available space.                                                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node DNS <cce_10_0446>`                                       | -  Check whether the DNS configuration of the current node can resolve the OBS address.                                                                                                                                   |
   |                                                                     | -  Check whether the current node can access the OBS address of the storage upgrade component package.                                                                                                                    |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Key Directory File Permissions <cce_10_0447>`            | Check whether the key directory **/var/paas** on the nodes contain files with abnormal owners or owner groups.                                                                                                            |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Kubelet <cce_10_0448>`                                        | Check whether the kubelet on the node is running properly.                                                                                                                                                                |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Memory <cce_10_0449>`                                    | Check whether the memory usage of the node exceeds 90%.                                                                                                                                                                   |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Clock Synchronization Server <cce_10_0450>`              | Check whether the clock synchronization server ntpd or chronyd of the node is running properly.                                                                                                                           |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node OS <cce_10_0451>`                                        | Check whether the OS kernel version of the node is supported by CCE.                                                                                                                                                      |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node CPU Count <cce_10_0452>`                                 | Check whether the number of CPUs on the master node is greater than 2.                                                                                                                                                    |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Python Command <cce_10_0453>`                            | Check whether the Python commands are available on a node.                                                                                                                                                                |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Readiness <cce_10_0455>`                                 | Check whether the nodes in the cluster are ready.                                                                                                                                                                         |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node journald <cce_10_0456>`                                  | Check whether journald of a node is normal.                                                                                                                                                                               |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`containerd.sock Check <cce_10_0457>`                          | Check whether the containerd.sock file exists on the node. This file affects the startup of container runtime in the Euler OS.                                                                                            |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Internal Error <cce_10_0458>`                                 | Before the upgrade, check whether an internal error occurs.                                                                                                                                                               |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Mount Point <cce_10_0459>`                               | Check whether inaccessible mount points exist on the node.                                                                                                                                                                |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Kubernetes Node Taint <cce_10_0460>`                          | Check whether the taint needed for cluster upgrade exists on the node.                                                                                                                                                    |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`everest Restriction Check <cce_10_0478>`                      | Check whether the current everest add-on has compatibility restrictions.                                                                                                                                                  |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`cce-hpa-controller Restriction Check <cce_10_0479>`           | Check whether the current cce-controller-hpa add-on has compatibility restrictions.                                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Enhanced CPU Management Policy <cce_10_0480>`                 | Check whether the current cluster version and the target version support enhanced CPU policy.                                                                                                                             |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`User Node Components Health <cce_10_0484>`                    | Check whether the container runtime and network components on the user node are healthy.                                                                                                                                  |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Controller Node Components Health <cce_10_0485>`              | Check whether the Kubernetes, container runtime, and network components of the controller node are healthy.                                                                                                               |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Memory Resource Limit of Kubernetes Components <cce_10_0486>` | Check whether the resources of Kubernetes components, such as etcd and kube-controller-manager, exceed the upper limit.                                                                                                   |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking Deprecated Kubernetes APIs <cce_10_0487>`            | Check whether the called API has been discarded in the target Kubernetes version.                                                                                                                                         |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`IPv6 Capability of a CCE Turbo Cluster <cce_10_0488>`         | If IPv6 is enabled for a CCE Turbo cluster, check whether the target cluster version supports IPv6.                                                                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node NetworkManager <cce_10_0489>`                            | Check whether NetworkManager of a node is normal.                                                                                                                                                                         |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node ID File <cce_10_0490>`                                   | Check the ID file format.                                                                                                                                                                                                 |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Configuration Consistency <cce_10_0491>`                 | When you upgrade a CCE cluster to v1.19 or later, the system checks whether the following configuration files have been modified in the background:                                                                       |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Node Configuration File <cce_10_0492>`                        | Check whether the configuration files of key components exist on the node.                                                                                                                                                |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | :ref:`Checking CoreDNS Configuration Consistency <cce_10_0493>`     | Check whether the current CoreDNS key configuration Corefile is different from the Helm release record. The difference may be overwritten during the add-on upgrade, **affecting domain name resolution in the cluster**. |
   +---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
