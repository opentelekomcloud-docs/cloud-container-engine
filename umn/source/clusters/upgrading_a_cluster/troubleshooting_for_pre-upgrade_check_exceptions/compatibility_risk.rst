:original_name: cce_10_0441.html

.. _cce_10_0441:

Compatibility Risk
==================

Check Item
----------

Read the version compatibility differences and ensure that they are not affected.

The patch upgrade does not involve version compatibility differences.

Version compatibility
---------------------

+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Major Version Upgrade Path           | Precaution                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Self-Check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+======================================+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+
| Upgrade from v1.19 to v1.21 or v1.23 | The bug of **exec probe timeouts** is fixed in Kubernetes 1.21. Before this bug fix, the exec probe does not consider the **timeoutSeconds** field. Instead, the probe will run indefinitely, even beyond its configured deadline. It will stop until the result is returned. If this field is not specified, the default value **1** is used. This field takes effect after the upgrade. If the probe runs over 1 second, the application health check may fail and the application may restart frequently. | Before the upgrade, check whether the timeout is properly set for the exec probe.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                      | kube-apiserver of CCE 1.19 or later requires that the Subject Alternative Names (SANs) field be configured for the certificate of your webhook server. Otherwise, kube-apiserver fails to call the webhook server after the upgrade, and containers cannot be started properly.                                                                                                                                                                                                                              | Before the upgrade, check whether the SAN field is configured in the certificate of your webhook server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      | Root cause: X.509 `CommonName <https://golang.google.cn/doc/go1.15#commonname>`__ is discarded in Go 1.15. kube-apiserver of CCE 1.19 is compiled using Go 1.15. If your webhook certificate does not have SANs, kube-apiserver does not process the **CommonName** field of the X.509 certificate as the host name by default. As a result, the authentication fails.                                                                                                                                       | -  If you do not have your own webhook server, you can skip this check.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  If the field is not set, you are advised to use the SAN field to specify the IP address and domain name supported by the certificate.                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                      | Arm nodes are not supported in clusters of v1.21 and later.                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Check whether your services will be affected if Arm nodes cannot be used.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Upgrade from v1.15 to v1.19          | The control plane of in the clusters v1.19 is incompatible with kubelet v1.15. If a node fails to be upgraded or the node to be upgraded restarts after the master node is successfully upgraded, there is a high probability that the node is in the **NotReady** status.                                                                                                                                                                                                                                   | #. In normal cases, this scenario is not triggered.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | #. After the master node is upgraded, do not suspend the upgrade so the node can be quickly upgraded.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                      | This is because the node failed to be upgraded restarts the kubelet and trigger the node registration. In clusters of v1.15, the default registration tags (**failure-domain.beta.kubernetes.io/is-baremetal** and **kubernetes.io/availablezone**) are regarded as invalid tags by the clusters of v1.19.                                                                                                                                                                                                   | #. If a node fails to be upgraded and cannot be restored, evict applications on the node as soon as possible. Contact technical support and skip the node upgrade. After the upgrade is complete, reset the node.                                                                                                                                                                                                                                                                                                                                                                           |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      | The valid tags in the clusters of v1.19 are **node.kubernetes.io/baremetal** and **failure-domain.beta.kubernetes.io/zone**.                                                                                                                                                                                                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                      | In CCE 1.15 and 1.19 clusters, the Docker storage driver file system is switched from XFS to Ext4. As a result, the import package sequence in the pods of the upgraded Java application may be abnormal, causing pod exceptions.                                                                                                                                                                                                                                                                            | Before the upgrade, check the Docker configuration file **/etc/docker/daemon.json** on the node. Check whether the value of **dm.fs** is **xfs**.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  If the value is **ext4** or the storage driver is Overlay, you can skip the next steps.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  If the value is **xfs**, you are advised to deploy applications in the cluster of the new version in advance to test whether the applications are compatible with the new cluster version.                                                                                                                                                                                                                                                                                                                                                                                               |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | .. code-block::                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "storage-driver": "devicemapper",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "storage-opts": [                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "dm.thinpooldev=/dev/mapper/vgpaas-thinpool",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "dm.use_deferred_removal=true",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "dm.fs=xfs",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          "dm.use_deferred_deletion=true"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          ]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                      | kube-apiserver of CCE 1.19 or later requires that the Subject Alternative Names (SANs) field be configured for the certificate of your webhook server. Otherwise, kube-apiserver fails to call the webhook server after the upgrade, and containers cannot be started properly.                                                                                                                                                                                                                              | Before the upgrade, check whether the SAN field is configured in the certificate of your webhook server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      | Root cause: X.509 `CommonName <https://golang.google.cn/doc/go1.15#commonname>`__ is discarded in Go 1.15. kube-apiserver of CCE 1.19 is compiled using Go 1.15. The **CommonName** field is processed as the host name. As a result, the authentication fails.                                                                                                                                                                                                                                              | -  If you do not have your own webhook server, you can skip this check.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -  If the field is not set, you are advised to use the SAN field to specify the IP address and domain name supported by the certificate.                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | .. important::                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |    NOTICE:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |    To mitigate the impact of version differences on cluster upgrade, CCE performs special processing during the upgrade from 1.15 to 1.19 and still supports certificates without SANs. However, no special processing is required for subsequent upgrades. You are advised to rectify your certificate as soon as possible.                                                                                                                                                                                                                                                                |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                      | In clusters of v1.17.17 and later, CCE automatically creates pod security policies (PSPs) for you, which restrict the creation of pods with unsafe configurations, for example, pods for which **net.core.somaxconn** under a sysctl is configured in the security context.                                                                                                                                                                                                                                  | After an upgrade, you can allow insecure system configurations as required. For details, see :ref:`Configuring a Pod Security Policy <cce_10_0275>`.                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Upgrade from v1.13 to v1.15          | After a VPC network cluster is upgraded, the master node occupies an extra CIDR block due to the upgrade of network components. If no container CIDR block is available for the new node, the pod scheduled to the node cannot run.                                                                                                                                                                                                                                                                          | This problem occurs when almost all CIDR blocks are occupied. For example, the container CIDR block is 10.0.0.0/16, the number of available IP addresses is 65,536, and the VPC network is allocated a CIDR block with the fixed size (using the mask to determine the maximum number of container IP addresses allocated to each node). If the upper limit is 128, the cluster supports a maximum of 512 (65536/128) nodes, including the three master nodes. After the cluster is upgraded, each of the three master nodes occupies one CIDR block. As a result, 506 nodes are supported. |
+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
