:original_name: cce_10_0208.html

.. _cce_10_0208:

Creating an HPA Policy
======================

As application access requests fluctuate, the preset number of pods often fails to meet the requirements for efficient, elastic resource utilization. For example, if the number of pods is insufficient during peak hours, the response delay may increase and user experience may deteriorate. If the number of pods is excessive during off-peak hours, resources go wasted.

Kubernetes provides the HPA policy to horizontally scale pods. The HPA policy monitors application loads, such as the CPU usage and memory usage, and automatically increases or decreases the number of pods to adapt to the current workload. This ensures stable application performance and efficient resource utilization.

Prerequisites
-------------

To use HPA, you have installed either of the following add-ons that support metrics APIs:

-  Kubernetes Metrics Server (:ref:`Kubernetes Metrics Server <cce_10_0205>`): provides basic resource usage metrics, such as container CPU and memory usage. The default collection period is 60s. It is supported by all cluster versions.
-  Cloud Native Cluster Monitoring (:ref:`Cloud Native Cluster Monitoring <cce_10_0406>`): available in clusters of v1.17 or later. The default collection period is 15s.

   -  Auto scaling based on basic resource metrics: Prometheus needs to be registered as a metrics API. For details, see :ref:`Providing Basic Resource Metrics Through the Metrics API <cce_10_0406__section17830202915211>`.
   -  Auto scaling based on custom metrics: Custom metrics need to be aggregated to the Kubernetes API server. For details, see :ref:`Creating an HPA Policy Using Custom Metrics <cce_10_0406__section11927514174016>`.

Notes and Constraints
---------------------

-  HPA policies can be created only for clusters of v1.13 or later.

-  For clusters earlier than v1.19.10, if an HPA policy is used to scale out a workload with EVS volumes mounted, the existing pods cannot be read or written when a new pod is scheduled to another node.

   For clusters of v1.19.10 and later, if an HPA policy is used to scale out a workload with EVS volumes mounted, a new pod cannot be started because EVS disks cannot be attached.

Procedure
---------

#. Log in to the CCE console and click the cluster name to access the cluster console.

#. Choose **Workloads** in the navigation pane. Locate the target workload and choose **More** > **Auto Scaling** in the **Operation** column.

#. Set **Policy Type** to **HPA+CronHPA**, enable the created HPA policy, and configure parameters.

   This section describes only HPA policies. To enable CronHPA, see :ref:`Creating a Scheduled CronHPA Policy <cce_10_0415>`.

   .. _cce_10_0208__table8638121213265:

   .. table:: **Table 1** HPA policy

      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Parameter                                                    | Description                                                                                                                                                                                                                                                                                             |
      +==============================================================+=========================================================================================================================================================================================================================================================================================================+
      | Pod Range                                                    | Minimum and maximum numbers of pods.                                                                                                                                                                                                                                                                    |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | When a policy is triggered, the workload pods are scaled within this range.                                                                                                                                                                                                                             |
      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Cooldown Period                                              | Interval between a scale-in and a scale-out. The unit is minute. **The interval cannot be shorter than 1 minute.**                                                                                                                                                                                      |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | **This parameter is supported only in clusters of v1.15 to v1.23.**                                                                                                                                                                                                                                     |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | This parameter indicates the interval between consecutive scaling operations. The cooldown period ensures that a scaling operation is initiated only when the previous one is completed and the system is running stably.                                                                               |
      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Scaling Behavior                                             | **This parameter is supported only in clusters of v1.25 or later.**                                                                                                                                                                                                                                     |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Default**: scales workloads using the Kubernetes default behavior. For details, see `Default Behavior <https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#default-behavior>`__.                                                                                            |
      |                                                              | -  **Custom**: scales workloads using custom policies such as stabilization window, steps, and priorities. Unspecified parameters use the values recommended by Kubernetes.                                                                                                                             |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    -  **Disable scale-out/scale-in**: Select whether to disable scale-out or scale-in.                                                                                                                                                                                                                  |
      |                                                              |    -  **Stabilization Window**: a period during which CCE continuously checks whether the metrics used for scaling keep fluctuating. CCE triggers scaling if the desired state is not maintained for the entire window. This window restricts the unwanted flapping of pod count due to metric changes. |
      |                                                              |    -  **Step**: specifies the scaling step. You can set the number or percentage of pods to be scaled in or out within a specified period. If there are multiple policies, you can select the policy that maximizes or minimizes the number of pods.                                                    |
      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | System Policy                                                | When calculating the number of pods to add or remove, HPA determines the target number of pods based on the current metric value, desired value, and the current number of pods. The current number of pods is the maximum number of pods over the last 5 minutes. The formula is as follows:           |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | **Desired number of pods = Rounded up value of [Current number of pods x (Current metric value/Desired value)]**                                                                                                                                                                                        |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Metric**: You can select **CPU usage** or **Memory usage**.                                                                                                                                                                                                                                        |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    **Usage = Average resource usage of all pods in a workload/Requested resources**                                                                                                                                                                                                                     |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Desired Value**: Enter the desired average resource usage.                                                                                                                                                                                                                                         |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Tolerance Range**: Scaling is not triggered when the metric value is within the tolerance range. The desired value must be within the tolerance range.                                                                                                                                             |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    If the metric value is greater than the scale-in threshold and less than the scale-out threshold, no scaling is triggered. **This parameter is supported only in clusters of v1.15 or later.**                                                                                                       |
      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Custom Policy (supported only in clusters of v1.15 or later) | .. note::                                                                                                                                                                                                                                                                                               |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    Before creating a custom policy, install an add-on that supports custom metric collection (for example, Prometheus) in the cluster. Ensure that the add-on can collect and report the custom metrics of the workloads.                                                                               |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    For details, see :ref:`Monitoring Custom Metrics Using Cloud Native Cluster Monitoring <cce_10_0373>`.                                                                                                                                                                                               |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Metric Name**: name of the custom metric. You can select a name as prompted.                                                                                                                                                                                                                       |
      |                                                              | -  **Metric Source**: Select an object type from the drop-down list. You can select **Pod**.                                                                                                                                                                                                            |
      |                                                              | -  **Desired Value**: the average metric value of all pods. Number of pods to be scaled (rounded up) = (Current metric value/Desired value) x Number of current pods                                                                                                                                    |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |    .. note::                                                                                                                                                                                                                                                                                            |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              |       When calculating the number of pods to be added or reduced, the HPA policy uses the maximum number of pods in the last 5 minutes.                                                                                                                                                                 |
      |                                                              |                                                                                                                                                                                                                                                                                                         |
      |                                                              | -  **Tolerance Range**: Scaling is not triggered when the metric value is within the tolerance range. The desired value must be within the tolerance range.                                                                                                                                             |
      +--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#. Click **Create**.
